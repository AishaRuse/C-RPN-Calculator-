<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HP-Style RPN Calculator</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RPN Calc">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    
    <!-- App Icons for iOS -->
    <link rel="apple-touch-icon" href="icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icon-167.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
    
    <!-- Splash Screens for iOS -->
    <link rel="apple-touch-startup-image" href="splash-2048x2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="splash-1668x2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="splash-1536x2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="splash-1242x2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="splash-1125x2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
    <link rel="apple-touch-startup-image" href="splash-828x1792.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="splash-750x1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icon-180.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Prevent iOS bounce scrolling and ensure full viewport */
        html, body {
            position: fixed;
            overflow: hidden;
            width: 100%;
            height: 100%;
            -webkit-overflow-scrolling: touch;
        }

        /* Allow scrolling in landscape when needed */
        @media (orientation: landscape) {
            html, body {
                position: relative;
                overflow-y: auto;
                height: auto;
                min-height: 100%;
            }
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            /* Support for iPhone notch */
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
        }

        /* Landscape mode adjustments */
        @media (orientation: landscape) {
            body {
                align-items: flex-start;
                padding-top: max(10px, env(safe-area-inset-top));
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }

            html, body {
                overflow-y: auto;
            }
        }

        .calculator {
            background: #2a2a2a;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 1200px;
            display: flex;
            gap: 30px;
        }

        /* Responsive layout adjustments */
        @media (max-width: 1024px) and (orientation: portrait) {
            .calculator {
                flex-direction: column;
                max-width: 600px;
                padding: 20px;
                gap: 20px;
            }

            .left-panel,
            .right-panel {
                flex: none;
                width: 100%;
            }
        }

        @media (max-width: 1366px) and (orientation: landscape) {
            .calculator {
                padding: 15px;
                gap: 20px;
                max-height: 90vh;
                overflow-y: auto;
            }

            body {
                padding: 10px;
            }
        }

        @media (max-width: 932px) and (orientation: landscape) {
            /* iPhone landscape */
            .calculator {
                padding: 10px;
                gap: 10px;
                max-height: 85vh;
            }

            .stack-display {
                padding: 10px;
            }

            .function-row {
                gap: 6px;
                margin-bottom: 6px;
            }

            .keypad {
                gap: 6px;
                height: 300px;
            }

            .key {
                padding: 10px;
                font-size: 14px;
            }
        }

        @media (max-width: 430px) {
            /* iPhone portrait */
            .calculator {
                padding: 15px;
                gap: 15px;
            }

            .mode-selector {
                gap: 8px;
            }

            .mode-btn {
                padding: 8px;
                font-size: 14px;
            }

            .stack-row {
                padding: 6px 8px;
            }

            .stack-value {
                font-size: 16px;
            }

            .input-value {
                font-size: 20px;
            }

            .key {
                padding: 15px;
                font-size: 16px;
            }

            .function-row {
                gap: 6px;
                margin-bottom: 6px;
            }

            .keypad {
                gap: 6px;
                height: 350px;
            }
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 0; /* Allow flex shrinking */
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 0; /* Allow flex shrinking */
        }

        .mode-selector {
            display: flex;
            gap: 10px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: #444;
            color: #aaa;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #ff6b35;
            color: white;
        }

        .stack-display {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 15px;
            flex: 1;
            overflow-y: auto;
            min-height: 200px;
        }

        /* In portrait mode, limit stack height */
        @media (orientation: portrait) {
            .stack-display {
                max-height: 400px;
            }
        }

        /* In landscape mode, make stack more compact */
        @media (orientation: landscape) {
            .stack-display {
                max-height: 60vh;
            }
        }

        .stack-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            margin: 2px 0;
            border-radius: 5px;
            background: #252525;
        }

        .stack-row.x-register {
            background: #333;
            border: 2px solid #ff6b35;
        }

        .stack-label {
            color: #888;
            font-weight: bold;
            min-width: 30px;
        }

        .stack-value {
            color: #0f0;
            font-size: 18px;
            text-align: right;
            flex: 1;
            font-weight: bold;
        }

        .input-display {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 15px;
            min-height: 60px;
        }

        .input-value {
            color: #fff;
            font-size: 24px;
            text-align: right;
            font-weight: bold;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 8px;
            height: 400px;
            min-height: 300px;
        }

        /* Adjust keypad for smaller screens */
        @media (max-height: 800px) and (orientation: landscape) {
            .keypad {
                height: 280px;
            }
        }

        .key {
            background: #444;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            padding: 20px;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 4px 0 #222;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0; /* Allow grid to control size */
        }

        /* Responsive key sizing */
        @media (max-width: 430px) {
            .key {
                padding: 12px;
                font-size: 16px;
                border-radius: 6px;
            }
        }

        @media (orientation: landscape) and (max-height: 800px) {
            .key {
                padding: 8px;
                font-size: 14px;
            }

            .key.function,
            .key.special,
            .key.math {
                font-size: 12px;
            }
        }

        .key:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #222;
        }

        .key:hover {
            background: #555;
        }

        .key.number {
            background: #555;
        }

        .key.number:hover {
            background: #666;
        }

        .key.operator {
            background: #ff6b35;
        }

        .key.operator:hover {
            background: #ff8555;
        }

        .key.enter {
            background: #4CAF50;
            grid-row: span 2;
        }

        .key.enter:hover {
            background: #5cb85c;
        }

        .key.plus {
            grid-row: span 2;
        }

        .key.zero {
            grid-column: span 2;
        }

        .key.function {
            background: #2196F3;
            font-size: 14px;
        }

        .key.function:hover {
            background: #42a5f5;
        }

        .key.special {
            background: #9C27B0;
            font-size: 14px;
        }

        .key.special:hover {
            background: #ab47bc;
        }

        .key.math {
            background: #FF9800;
            font-size: 14px;
        }

        .key.math:hover {
            background: #FFa726;
        }


        .memory-indicator {
            color: #ff6b35;
            font-size: 12px;
            text-align: center;
            min-height: 20px;
        }

        .wide-section {
        }

        .function-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="calculator">
        <div class="left-panel">
            <div class="mode-selector">
                <button class="mode-btn active" data-mode="decimal">Decimal</button>
                <button class="mode-btn" data-mode="integer">Integer</button>
                <button class="mode-btn" data-mode="currency">Currency</button>
            </div>

            <div class="memory-indicator" id="memoryIndicator"></div>

            <div class="stack-display" id="stackDisplay"></div>
        </div>

        <div class="right-panel">
            <div class="input-display">
                <div class="input-value" id="inputDisplay">0</div>
            </div>

            <div class="wide-section">
                <!-- Row 1: Memory basic (Purple) -->
                <div class="function-row">
                    <button class="key special" data-key="STO">STO</button>
                    <button class="key special" data-key="RCL">RCL</button>
                    <button class="key special" data-key="RCL+">RCL+</button>
                    <button class="key special" data-key="RCL-">RCL−</button>
                </div>
                <!-- Row 2: Memory operations (Purple) -->
                <div class="function-row">
                    <button class="key special" data-key="STO+">STO+</button>
                    <button class="key special" data-key="STO-">STO−</button>
                    <button class="key special" data-key="STO*">STO×</button>
                    <button class="key special" data-key="STO/">STO÷</button>
                </div>
                <!-- Row 3: Stack operations (Blue) -->
                <div class="function-row">
                    <button class="key function" data-key="CLEAR">CLEAR</button>
                    <button class="key function" data-key="DROP">DROP</button>
                    <button class="key function" data-key="SWAP">SWAP</button>
                    <button class="key function" data-key="CLX">CLX</button>
                </div>
                <!-- Row 4: Stack manipulation (Blue) -->
                <div class="function-row">
                    <button class="key function" data-key="ROLL↑">ROLL↑</button>
                    <button class="key function" data-key="ROLL↓">ROLL↓</button>
                    <button class="key function" data-key="LASTX">LASTX</button>
                    <button class="key" style="background: transparent; box-shadow: none; cursor: default;"></button>
                </div>
                <!-- Row 5: Math functions (Orange/Amber) -->
                <div class="function-row">
                    <button class="key math" data-key="CHS">CHS</button>
                    <button class="key math" data-key="1/x">1/x</button>
                    <button class="key math" data-key="Δ%">Δ%</button>
                    <button class="key" style="background: transparent; box-shadow: none; cursor: default;"></button>
                </div>
            </div>

            <div class="keypad">
                <!-- Row 1: % / * - -->
                <button class="key operator" data-key="%">%</button>
                <button class="key operator" data-key="/">/</button>
                <button class="key operator" data-key="*">×</button>
                <button class="key operator" data-key="-">−</button>
                
                <!-- Row 2: 7 8 9 + (+ spans 2 rows) -->
                <button class="key number" data-key="7">7</button>
                <button class="key number" data-key="8">8</button>
                <button class="key number" data-key="9">9</button>
                <button class="key operator plus" data-key="+">+</button>
                
                <!-- Row 3: 4 5 6 (+ continues from row 2) -->
                <button class="key number" data-key="4">4</button>
                <button class="key number" data-key="5">5</button>
                <button class="key number" data-key="6">6</button>
                
                <!-- Row 4: 1 2 3 ENTER (Enter starts and spans 2 rows) -->
                <button class="key number" data-key="1">1</button>
                <button class="key number" data-key="2">2</button>
                <button class="key number" data-key="3">3</button>
                <button class="key enter" data-key="ENTER">ENTER</button>
                
                <!-- Row 5: 0 (spans 2 cols) . (Enter continues from row 4) -->
                <button class="key number zero" data-key="0">0</button>
                <button class="key number" data-key=".">.</button>
            </div>
        </div>
    </div>

    <script>
        class RPNCalculator {
            constructor() {
                this.stack = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                this.input = '';
                this.mode = 'decimal'; // 'decimal', 'integer', 'currency'
                this.memory = 0;
                this.lastX = 0;
                this.enterPressed = false;
                this.PRECISION = 16;
            }

            formatValue(value) {
                if (this.mode === 'integer') {
                    return Math.round(value).toString();
                } else if (this.mode === 'currency') {
                    // Format with 2 decimal places and thousand separators
                    const fixed = value.toFixed(2);
                    const parts = fixed.split('.');
                    // Add thousand separators to integer part
                    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    return parts.join('.');
                } else {
                    // Decimal mode - show up to 16 significant digits
                    if (Math.abs(value) < 1e-10) return '0';
                    let str = value.toPrecision(this.PRECISION);
                    // Remove trailing zeros and decimal point if not needed
                    str = parseFloat(str).toString();
                    return str;
                }
            }

            getCurrentInput() {
                if (this.input === '' || this.input === '-') {
                    return this.stack[0];
                }
                return parseFloat(this.input) || 0;
            }

            pushStack(value) {
                this.stack.unshift(value);
                this.stack.pop();
            }

            popStack() {
                const value = this.stack[0];
                this.stack.shift();
                this.stack.push(0);
                return value;
            }

            enter() {
                if (this.input !== '') {
                    const value = parseFloat(this.input);
                    this.pushStack(value);
                    this.input = '';
                    this.enterPressed = true;
                } else {
                    // Duplicate X register
                    this.pushStack(this.stack[0]);
                }
            }

            operation(op) {
                if (this.input !== '') {
                    this.enter();
                }

                const x = this.popStack();
                const y = this.popStack();
                this.lastX = x;
                let result;

                switch(op) {
                    case '+': result = y + x; break;
                    case '-': result = y - x; break;
                    case '*': result = y * x; break;
                    case '/': result = x !== 0 ? y / x : 0; break;
                    case '%': result = (y * x) / 100; break;
                    default: result = 0;
                }

                this.pushStack(result);
                this.enterPressed = false;
            }

            clearX() {
                this.input = '';
                this.stack[0] = 0;
            }

            recallLastX() {
                if (this.input !== '') {
                    this.enter();
                }
                this.pushStack(this.lastX);
            }

            rollUp() {
                const temp = this.stack[0];
                for (let i = 0; i < 11; i++) {
                    this.stack[i] = this.stack[i + 1];
                }
                this.stack[11] = temp;
            }

            rollDown() {
                const temp = this.stack[11];
                for (let i = 11; i > 0; i--) {
                    this.stack[i] = this.stack[i - 1];
                }
                this.stack[0] = temp;
            }

            store() {
                const value = this.getCurrentInput();
                this.memory = value;
            }

            recall() {
                if (this.input !== '') {
                    this.enter();
                }
                this.pushStack(this.memory);
            }

            storeOp(op) {
                const x = this.getCurrentInput();
                switch(op) {
                    case '+': this.memory += x; break;
                    case '-': this.memory -= x; break;
                    case '*': this.memory *= x; break;
                    case '/': this.memory = x !== 0 ? this.memory / x : this.memory; break;
                }
            }

            deltaPercent() {
                if (this.input !== '') {
                    this.enter();
                }
                const x = this.popStack();
                const y = this.popStack();
                this.lastX = x;
                const result = y !== 0 ? ((x - y) / y) * 100 : 0;
                this.pushStack(result);
            }

            changeSign() {
                if (this.input !== '') {
                    if (this.input === '0' || this.input === '-0') {
                        this.input = '';
                        return;
                    }
                    if (this.input.startsWith('-')) {
                        this.input = this.input.substring(1);
                    } else {
                        this.input = '-' + this.input;
                    }
                } else {
                    this.stack[0] = -this.stack[0];
                }
            }

            deleteLastChar() {
                if (this.input.length > 0) {
                    this.input = this.input.slice(0, -1);
                }
            }

            reciprocal() {
                if (this.input !== '') {
                    this.enter();
                }
                const x = this.stack[0];
                this.lastX = x;
                if (x !== 0) {
                    this.stack[0] = 1 / x;
                }
            }

            clear() {
                // Clear entire stack and input
                this.stack = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                this.input = '';
                this.enterPressed = false;
            }

            drop() {
                // Drop X register, move stack down
                this.input = '';
                this.stack.shift();
                this.stack.push(0);
                this.enterPressed = false;
            }

            swap() {
                // Swap X and Y registers
                if (this.input !== '') {
                    this.enter();
                }
                const temp = this.stack[0];
                this.stack[0] = this.stack[1];
                this.stack[1] = temp;
            }

            recallOp(op) {
                // RCL+ and RCL−: combines memory with X and leaves result in X
                const x = this.getCurrentInput();
                if (this.input !== '') {
                    this.enter();
                }
                switch(op) {
                    case '+': this.stack[0] = this.memory + x; break;
                    case '-': this.stack[0] = this.memory - x; break;
                }
            }
        }

        const calc = new RPNCalculator();

        function updateDisplay() {
            const stackDisplay = document.getElementById('stackDisplay');
            const inputDisplay = document.getElementById('inputDisplay');
            const memoryIndicator = document.getElementById('memoryIndicator');

            // Update stack display
            const labels = ['X:', 'Y:', 'Z:', 'T:', '4:', '5:', '6:', '7:', '8:', '9:', '10:', '11:'];
            stackDisplay.innerHTML = '';
            
            for (let i = 0; i < 12; i++) {
                const row = document.createElement('div');
                row.className = 'stack-row' + (i === 0 ? ' x-register' : '');
                
                const label = document.createElement('div');
                label.className = 'stack-label';
                label.textContent = labels[i];
                
                const value = document.createElement('div');
                value.className = 'stack-value';
                value.textContent = calc.formatValue(calc.stack[i]);
                
                row.appendChild(label);
                row.appendChild(value);
                stackDisplay.appendChild(row);
            }

            // Update input display
            if (calc.input !== '') {
                inputDisplay.textContent = calc.input;
            } else {
                inputDisplay.textContent = calc.formatValue(calc.stack[0]);
            }

            // Update memory indicator
            if (calc.memory !== 0) {
                memoryIndicator.textContent = `Memory: ${calc.formatValue(calc.memory)}`;
            } else {
                memoryIndicator.textContent = '';
            }
        }

        function handleKey(key) {
            // Check multi-character keys first before single character checks
            if (key === '1/x') {
                calc.reciprocal();
            } else if (key === 'ENTER') {
                calc.enter();
            } else if (['+', '-', '*', '/', '%'].includes(key)) {
                calc.operation(key);
            } else if (key === 'CLX') {
                calc.clearX();
            } else if (key === 'LASTX') {
                calc.recallLastX();
            } else if (key === 'ROLL↑') {
                calc.rollUp();
            } else if (key === 'ROLL↓') {
                calc.rollDown();
            } else if (key === 'STO') {
                calc.store();
            } else if (key === 'RCL') {
                calc.recall();
            } else if (key === 'STO+') {
                calc.storeOp('+');
            } else if (key === 'STO-') {
                calc.storeOp('-');
            } else if (key === 'STO*') {
                calc.storeOp('*');
            } else if (key === 'STO/') {
                calc.storeOp('/');
            } else if (key === 'Δ%') {
                calc.deltaPercent();
            } else if (key === 'CHS') {
                calc.changeSign();
            } else if (key === 'CLEAR') {
                calc.clear();
            } else if (key === 'DROP') {
                calc.drop();
            } else if (key === 'SWAP') {
                calc.swap();
            } else if (key === 'RCL+') {
                calc.recallOp('+');
            } else if (key === 'RCL-') {
                calc.recallOp('-');
            } else if (key >= '0' && key <= '9') {
                if (calc.enterPressed) {
                    calc.input = '';
                    calc.enterPressed = false;
                }
                calc.input += key;
            } else if (key === '.') {
                if (calc.mode === 'integer') return;
                if (calc.enterPressed) {
                    calc.input = '0';
                    calc.enterPressed = false;
                }
                if (calc.input === '') calc.input = '0';
                if (!calc.input.includes('.')) calc.input += '.';
            }
            
            updateDisplay();
        }

        // Button click handlers
        document.querySelectorAll('.key').forEach(button => {
            button.addEventListener('click', () => {
                handleKey(button.dataset.key);
            });
        });

        // Mode selector
        document.querySelectorAll('.mode-btn').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                button.classList.add('active');
                calc.mode = button.dataset.mode;
                updateDisplay();
            });
        });

        // Keyboard support
        document.addEventListener('keydown', (e) => {
            e.preventDefault();
            
            const keyMap = {
                '0': '0', '1': '1', '2': '2', '3': '3', '4': '4',
                '5': '5', '6': '6', '7': '7', '8': '8', '9': '9',
                '.': '.', ',': '.',
                'Enter': 'ENTER',
                '+': '+', '-': '-', '*': '*', '/': '/',
                'Delete': 'CLX',
                'Escape': 'CLEAR',
                '%': '%'
            };
            
            // Backspace: delete char if inputting, otherwise CLX
            if (e.key === 'Backspace') {
                if (calc.input !== '') {
                    calc.input = calc.input.slice(0, -1);
                    updateDisplay();
                } else {
                    handleKey('CLX');
                }
                return;
            }
            
            if (keyMap[e.key]) {
                handleKey(keyMap[e.key]);
            }
        });

        // Initial display
        updateDisplay();
    </script>
</body>
</html>